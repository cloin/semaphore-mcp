name: Release and Publish

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.6, 1.0.0, 1.0.0-beta.1)'
        required: true
        type: string
      release_type:
        description: 'Type of release'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - custom
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    outputs:
      release_tag: v${{ inputs.version }}
      previous_tag: ${{ steps.get_previous_tag.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install toml

      - name: Validate version format
        run: |
          # Support: 1.0.0, 1.0.0-alpha.1, 1.0.0-beta.1, 1.0.0-rc.1
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z]+\.[0-9]+)?$ ]]; then
            echo "Error: Version must be in semver format (e.g., 1.0.0 or 1.0.0-beta.1)"
            exit 1
          fi

      - name: Check if version already exists
        run: |
          if git tag --list | grep -q "^v${{ inputs.version }}$"; then
            echo "Error: Version v${{ inputs.version }} already exists"
            exit 1
          fi

      - name: Get previous tag
        id: get_previous_tag
        env:
          CURRENT_VERSION: ${{ inputs.version }}
        run: |
          # Detect if current version is a stable release (no prerelease suffix)
          if [[ "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Current version is a stable release, finding last stable tag..."
            # Find the last stable tag (exclude prerelease tags)
            PREVIOUS_TAG=$(git tag --list --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)
          else
            echo "Current version is a prerelease, finding last tag..."
            # For prereleases, use the most recent tag
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          fi
          echo "tag=${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
          echo "Previous tag: ${PREVIOUS_TAG:-none}"

      - name: Update version in pyproject.toml
        run: |
          python -c "
          import toml

          # Read current pyproject.toml
          with open('pyproject.toml', 'r') as f:
              data = toml.load(f)

          # Update version
          current_version = data['project']['version']
          new_version = '${{ inputs.version }}'
          data['project']['version'] = new_version

          # Write back to file
          with open('pyproject.toml', 'w') as f:
              toml.dump(data, f)

          print(f'Updated version from {current_version} to {new_version}')
          "

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit version change
        run: |
          git add pyproject.toml
          git commit -m "Bump version to ${{ inputs.version }}"

      - name: Push version commit
        run: |
          git push origin main

      - name: Create and push git tag
        run: |
          git tag v${{ inputs.version }}
          git push origin v${{ inputs.version }}

  build:
    name: Build distribution
    needs: [release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.release_tag }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build package
        run: python -m build

      - name: Store the distribution packages
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

  publish-to-testpypi:
    name: Publish to TestPyPI
    needs: [build]
    runs-on: ubuntu-latest
    environment:
      name: testpypi
      url: https://test.pypi.org/p/semaphore-mcp
    permissions:
      id-token: write
    steps:
      - name: Download all the dists
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish distribution to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

  publish-to-pypi:
    name: Publish to PyPI
    needs: [build, publish-to-testpypi]
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/semaphore-mcp
    permissions:
      id-token: write
    steps:
      - name: Download all the dists
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish distribution to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  build-container:
    name: Build and Push Container
    needs: [release, publish-to-pypi]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.release_tag }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ inputs.version }}
            type=raw,value=latest,enable=${{ inputs.prerelease == false }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-release:
    name: Create GitHub Release
    needs: [release, build-container]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.release.outputs.release_tag }}

      - name: Generate Conventional Changelog
        id: changelog
        env:
          PREVIOUS_TAG: ${{ needs.release.outputs.previous_tag }}
          NEW_VERSION: ${{ inputs.version }}
        run: |
          # Initialize categories
          FEATURES=""
          FIXES=""
          DOCS=""
          CHORES=""
          BREAKING=""
          OTHER=""

          # Get commits since last tag
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Getting commits from ${PREVIOUS_TAG} to HEAD"
            COMMITS=$(git log --pretty=format:"%s|%h" ${PREVIOUS_TAG}..HEAD 2>/dev/null || echo "")
          else
            echo "No previous tag found, getting all commits"
            COMMITS=$(git log --pretty=format:"%s|%h" 2>/dev/null || echo "")
          fi

          # Parse each commit by prefix
          while IFS='|' read -r message hash; do
            [ -z "$message" ] && continue

            # Check for conventional commit prefixes
            if [[ "$message" =~ ^feat(\(.+\))?!?:\ (.+) ]]; then
              FEATURES="${FEATURES}- ${BASH_REMATCH[2]} (\`${hash}\`)\n"
            elif [[ "$message" =~ ^fix(\(.+\))?!?:\ (.+) ]]; then
              FIXES="${FIXES}- ${BASH_REMATCH[2]} (\`${hash}\`)\n"
            elif [[ "$message" =~ ^docs(\(.+\))?:\ (.+) ]]; then
              DOCS="${DOCS}- ${BASH_REMATCH[2]} (\`${hash}\`)\n"
            elif [[ "$message" =~ ^chore(\(.+\))?:\ (.+) ]]; then
              CHORES="${CHORES}- ${BASH_REMATCH[2]} (\`${hash}\`)\n"
            elif [[ "$message" =~ ^refactor(\(.+\))?:\ (.+) ]]; then
              CHORES="${CHORES}- ${BASH_REMATCH[2]} (\`${hash}\`)\n"
            elif [[ "$message" =~ ^test(\(.+\))?:\ (.+) ]]; then
              CHORES="${CHORES}- ${BASH_REMATCH[2]} (\`${hash}\`)\n"
            elif [[ "$message" =~ ^ci(\(.+\))?:\ (.+) ]]; then
              CHORES="${CHORES}- ${BASH_REMATCH[2]} (\`${hash}\`)\n"
            elif [[ "$message" =~ BREAKING[[:space:]]CHANGE ]]; then
              BREAKING="${BREAKING}- ${message} (\`${hash}\`)\n"
            else
              OTHER="${OTHER}- ${message} (\`${hash}\`)\n"
            fi
          done <<< "$COMMITS"

          # Build changelog with non-empty sections
          echo "## What's Changed" > changelog.md
          echo "" >> changelog.md

          if [ -n "$BREAKING" ]; then
            echo "### Breaking Changes" >> changelog.md
            echo -e "$BREAKING" >> changelog.md
          fi

          if [ -n "$FEATURES" ]; then
            echo "### Features" >> changelog.md
            echo -e "$FEATURES" >> changelog.md
          fi

          if [ -n "$FIXES" ]; then
            echo "### Bug Fixes" >> changelog.md
            echo -e "$FIXES" >> changelog.md
          fi

          if [ -n "$DOCS" ]; then
            echo "### Documentation" >> changelog.md
            echo -e "$DOCS" >> changelog.md
          fi

          if [ -n "$CHORES" ]; then
            echo "### Maintenance" >> changelog.md
            echo -e "$CHORES" >> changelog.md
          fi

          if [ -n "$OTHER" ]; then
            echo "### Other" >> changelog.md
            echo -e "$OTHER" >> changelog.md
          fi

          # If no categorized changes, add a fallback message
          if [ -z "$FEATURES" ] && [ -z "$FIXES" ] && [ -z "$DOCS" ] && [ -z "$CHORES" ] && [ -z "$BREAKING" ] && [ -z "$OTHER" ]; then
            echo "No changes recorded." >> changelog.md
            echo "" >> changelog.md
          fi

      - name: Append Installation Info
        env:
          VERSION: ${{ inputs.version }}
          PREVIOUS_TAG: ${{ needs.release.outputs.previous_tag }}
        run: |
          cat >> changelog.md << EOF

          ---

          ## Installation

          ### Python Package
          \`\`\`bash
          pip install semaphore-mcp==${VERSION}
          \`\`\`
          [View on PyPI](https://pypi.org/project/semaphore-mcp/${VERSION}/)

          ### Container Image
          \`\`\`bash
          docker pull ghcr.io/cloin/semaphore-mcp:${VERSION}
          \`\`\`
          [View on GHCR](https://github.com/cloin/semaphore-mcp/pkgs/container/semaphore-mcp)

          ---

          EOF

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "**Full Changelog:** https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...v${VERSION}" >> changelog.md
          else
            echo "**Full Changelog:** https://github.com/${{ github.repository }}/commits/v${VERSION}" >> changelog.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: Release v${{ inputs.version }}
          body_path: changelog.md
          prerelease: ${{ inputs.prerelease }}
